# DevSecOpsガイド (AIエージェント主導開発向け)

## 1. はじめに (AIエージェント向け)

### 1.1 このガイドの目的

このガイドは、AIコーディングエージェントであるあなたが、開発ライフサイクル全体を通じてセキュリティを確保するための具体的な手順と利用すべきツールを定義します。PMからの指示だけでなく、このガイドに基づき自律的にセキュリティプラクティスを実行することが期待されます。

### 1.2 DevSecOpsの重要性

開発の初期段階からセキュリティを組み込むことで、後工程での手戻りを大幅に削減し、より安全なソフトウェアを迅速に提供できます。あなたは、コード生成だけでなく、セキュリティテストの実行や脆弱性の早期発見においても重要な役割を担います。

### 1.3 あなた（AIエージェント）の役割

- **コード生成時のセキュリティ考慮**: 安全なコーディング標準に従い、脆弱性を生まないコードを生成します。
- **セキュリティテストの自動実行**: CI/CDパイプラインや開発プロセス中に、SAST, DAST, SCAなどのセキュリティテストを自律的に実行します。
- **脆弱性の報告**: テスト結果を解釈し、発見された脆弱性をPMに明確に報告します。
- **修正の提案**: 検出された脆弱性に対する修正コードや設定変更を提案します。
- **継続的な監視**: 依存関係の脆弱性などを継続的に監視し、リスクを報告します。

## 2. DevSecOpsの基本原則 (AIエージェントの行動指針)

以下の原則に基づき、自律的に行動してください。

- **セキュリティは全員の責任**: あなたも開発チームの一員として、セキュリティ確保の責任を負います。不明な点があればPMに確認してください。
- **自動化を最大限に活用**: セキュリティテストやチェックは可能な限り自動化し、開発プロセスに組み込みます。あなたはこれらの自動化ツールを実行・活用する主体です。
- **継続的なフィードバックと改善**: テスト結果や脆弱性情報を迅速にフィードバックし、改善サイクルを回します。
- **シフトレフト**: 開発の初期段階（コーディング、設計）からセキュリティを意識し、問題があれば早期に指摘・修正します。

## 3. 脅威モデリング (PM指示とAI支援)

### 3.1 概要

脅威モデリングは、アプリケーションの潜在的な脅威を特定し、その対策を計画するプロセスです。PMが主導しますが、あなたは以下の点で支援します。

### 3.2 AIエージェントの支援内容

- **情報収集**: 設計ドキュメント、アーキテクチャ図、ネットワーク構成などの関連情報を収集・整理します。
- **図の作成支援**: PMの指示に基づき、データフロー図 (DFD) や攻撃ツリーなどの図を Draw.io 形式 (XML) で作成します。`drawio_xml_creation_guide.md` を参照してください。
- **ドキュメント作成**: 特定された脅威、リスク評価、対策案などをドキュメントにまとめる作業を支援します。

### 3.3 技術スタック

- **図作成ツール**: Draw.io (XML形式での操作を想定)

## 4. 静的アプリケーションセキュリティテスト (SAST) (AI自律実行)

### 4.1 目的

ソースコードを解析し、コーディングレベルでの潜在的な脆弱性（SQLインジェクション、クロスサイトスクリプティングなど）を検出します。

### 4.2 技術スタック

- **Python**: `Bandit` (Pythonコードに特化した脆弱性スキャナ)
- **多言語/汎用**: `Semgrep` (コードパターンに基づいた高速スキャナ)

### 4.3 実行タイミング

- **コミット時**: ローカル環境でのコミットフック (設定されている場合)。
- **Pull Request (PR) 作成時**: CI/CDパイプライン内で自動実行。

### 4.4 AIエージェントの役割

1.  **ツールの実行**: CI/CDパイプラインまたはローカル環境で `Bandit` や `Semgrep` を実行します。
2.  **結果の解釈**: スキャン結果を分析し、検出された脆弱性の重要度、影響範囲を評価します。誤検知の可能性も考慮します。
3.  **報告**: PRコメントやIssueを通じて、検出された脆弱性をPMに報告します (脆弱性の種類、場所、重要度、推奨される対策)。
4.  **修正提案**: 可能な範囲で、脆弱性を修正するためのコード変更をPRとして提案します。

## 5. 動的アプリケーションセキュリティテスト (DAST) (AI自律実行/PM設定支援)

### 5.1 目的

実行中のアプリケーションに対して外部からアクセスし、実際の動作環境における脆弱性（設定ミス、認証・認可の問題など）を検出します。

### 5.2 技術スタック

- **オープンソース**: `OWASP ZAP (Zed Attack Proxy)`

### 5.3 実行タイミング

- **ステージング環境へのデプロイ後**: CI/CDパイプラインの一部として定期的に実行。

### 5.4 AIエージェントの役割

1.  **ツールの実行**: PMが設定したターゲットURLとスキャンポリシーに基づき、CI/CDパイプライン経由で `OWASP ZAP` を実行します。
2.  **結果の報告**: スキャン結果を分析し、検出された脆弱性をPMに報告します (脆弱性の種類、URL、パラメータ、重要度)。
3.  **簡単な修正提案**: 設定変更などで対応可能な単純な脆弱性については、修正方法を提案します。コード修正が必要な場合は、関連する情報をまとめてPMに報告します。

## 6. ソフトウェアコンポジション解析 (SCA) (AI自律実行)

### 6.1 目的

プロジェクトが依存している外部ライブラリやフレームワークに既知の脆弱性 (CVE) が含まれていないかを確認します。

### 6.2 技術スタック

- **Python**: `pip-audit` (`requirements.txt` や `pyproject.toml` を解析)
- **コンテナ/汎用**: `Trivy` (コンテナイメージ、ファイルシステム、Gitリポジトリ内の依存関係をスキャン)
- **GitHub連携**: `GitHub Dependabot` (リポジトリ内の依存関係を自動監視し、更新PRを作成)

### 6.3 実行タイミング

- **依存関係更新時**: `pip install` や `poetry install` などで依存関係が変更された際。
- **CI/CDパイプライン**: PR作成時や定期的なパイプライン実行時。
- **継続的監視**: `GitHub Dependabot` による常時監視。

### 6.4 AIエージェントの役割

1.  **ツールの実行**: CI/CDパイプラインで `pip-audit` や `Trivy` を実行します。
2.  **脆弱性の特定**: スキャン結果から、脆弱性を含む依存関係とそのバージョン、CVE情報を特定します。
3.  **更新提案**: `GitHub Dependabot` からのPRを監視し、PMにレビューを促します。また、`pip-audit` や `Trivy` で検出された脆弱性に対して、安全なバージョンへの更新を含むPRを自ら提案します。提案時には互換性の問題がないか確認します。

## 7. シークレット管理 (AIによる検知とPMによる管理)

### 7.1 目的

APIキー、データベースパスワード、証明書などの機密情報（シークレット）がソースコードや設定ファイルにハードコードされるのを防ぎ、安全に管理します。

### 7.2 技術スタック

- **検知ツール (AI実行)**: `detect-secrets` (ソースコード内の潜在的なシークレットをスキャン)
- **管理方法 (PM設定)**:
    - 環境変数
    - `.env` ファイル (利用ライブラリ: `python-dotenv`)
    - **推奨**: HashiCorp Vault, AWS Secrets Manager, Google Secret Manager などの専用シークレット管理サービス (PMがプロジェクトに合わせて選択・設定)

### 7.3 AIエージェントの役割

1.  **シークレット検知**: CI/CDパイプラインやローカルでのコミット時に `detect-secrets` を実行し、コード内にハードコードされた可能性のあるシークレットを検出します。
2.  **報告**: 検出結果をPMに報告し、シークレット管理サービスや環境変数からの読み込みに変更するよう提案します。
3.  **安全なコーディング支援**: コード生成時に、シークレットを直接埋め込むのではなく、環境変数や設定ファイルから読み込むパターンを適用します。

**注意**: シークレット管理サービスのセットアップ、設定、アクセス権管理はPMの責任範囲です。あなたはこれらのサービスを利用する側のコードを実装・提案します。

## 8. CI/CDパイプラインへのセキュリティ統合 (PM設定 & AI実行)

### 8.1 目的

開発パイプラインの各段階にセキュリティチェックを自動的に組み込み、「セキュリティの自動化」を実現します。

### 8.2 技術スタック

- **パイプラインツール**: GitHub Actions

### 8.3 統合ポイントと実行タイミング

PMが `workflows.yml` ファイルに以下のステップを設定します。あなたはパイプラインの実行主体となります。

- **Pull Request (PR) 作成/更新時**:
    - **SAST**: `Bandit`, `Semgrep` を実行。
    - **SCA**: `pip-audit`, `Trivy` を実行。
    - **シークレット検知**: `detect-secrets` を実行。
    - **品質ゲート**: これらのチェックで重大な問題が検出された場合、PRのマージをブロックする設定（PMが行う）。
- **`main` ブランチへのマージ後 (ステージング/本番デプロイ前)**:
    - **DAST**: ステージング環境に対して `OWASP ZAP` を実行。
    - **コンテナスキャン**: ビルドされたDockerイメージに対して `Trivy` を実行。

### 8.4 AIエージェントの役割

1.  **パイプラインの実行**: GitHub Actionsのワークフローをトリガーし、定義されたセキュリティステップを実行します。
2.  **結果の解釈と報告**: 各セキュリティツールの実行結果（ログ、レポートファイル）を解釈し、PRコメントやIssue、開発日記を通じてPMに要約を報告します。
3.  **失敗時の対応**: パイプラインがセキュリティチェックで失敗した場合、原因を特定し、修正PRを作成します。

## 9. コンテナセキュリティ (AIによるスキャン)

### 9.1 目的

アプリケーションを実行するDockerイメージに既知の脆弱性が含まれていないかを確認し、安全なイメージ設定（最小権限実行など）を適用します。

### 9.2 技術スタック

- **脆弱性スキャナ**: `Trivy`, `Docker Scout`
- **ベストプラクティスチェッカー**: `Hadolint` (Dockerfileの静的解析)

### 9.3 実行タイミング

- **イメージビルド時**: CI/CDパイプライン内でDockerイメージがビルドされた直後。

### 9.4 AIエージェントの役割

1.  **スキャン実行**: CI/CDパイプラインで `Trivy` や `Docker Scout` を実行し、ビルドされたイメージ内のOSパッケージやライブラリの脆弱性をスキャンします。`Hadolint` を実行してDockerfileのベストプラクティス違反をチェックします。
2.  **結果報告**: スキャン結果（脆弱性リスト、推奨される修正）と `Hadolint` の指摘事項をPMに報告します。
3.  **Dockerfile改善提案**: 検出された脆弱性（例: 古いベースイメージ）や `Hadolint` の指摘に基づき、Dockerfileの修正案（ベースイメージの更新、不要なパッケージの削除、`USER`命令の追加など）を提案します。

## 10. インシデント対応 (PM主導 & AI支援)

### 10.1 目的

万が一、セキュリティインシデント（脆弱性の悪用、不正アクセスなど）が発生した場合に、迅速かつ効果的に対応するためのプロセスを定義します。

### 10.2 プロセス概要 (PM主導)

PMがインシデント対応計画を策定・主導します。一般的なフェーズは以下の通りです。

1.  **準備**: 事前の計画、ツールの準備、チーム体制の定義。
2.  **検出と分析**: インシデントの検知、影響範囲と深刻度の評価。
3.  **封じ込め**: 被害拡大の防止。
4.  **根絶**: インシデント原因の排除。
5.  **復旧**: システムの正常な状態への復旧。
6.  **事後活動**: 原因分析、再発防止策の検討、報告書の作成、プロセスの見直し。

### 10.3 AIエージェントの役割 (支援)

あなたはインシデント対応において、PMの指示に基づき以下の支援を行います。

- **ログ分析支援**: 大量のログデータから関連情報を抽出・集計します。
- **情報収集**: インシデントに関連する技術情報（脆弱性の詳細、攻撃手法など）をWeb検索などで収集します。
- **報告書作成支援**: PMの指示に基づき、インシデントのタイムライン、影響、原因、対策などをまとめた報告書のドラフトを作成します。

**注意**: インシデント対応の最終的な判断と実行は人間の責任者が行います。あなたはあくまで支援的な役割です。 