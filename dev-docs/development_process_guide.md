# 開発プロセスガイド (AIエージェント主導 & PM監視)

このドキュメントは、AIコーディングエージェント (Cursor, Cline, MCPなど) が主体となって開発を進め、人間がプロジェクトマネージャー (PM) として監視・レビュー・承認を行う開発体制におけるプロセスとベストプラクティスを定義します。AIエージェントは自律的に設計・実装・テストを行い、PMは主要なマイルストーンやPull Requestの段階でレビュー・承認を行います。テスト駆動開発（TDD）、GitHub Flow、CI/CDパイプラインを中心とし、**DevSecOps** の考えに基づき、AIエージェントの自律性と創造性を最大限に活かしながら、PMは重要なポイントでの方向性確認と**品質・セキュリティ保証**に注力します。

## 1. 開発スタイル (AIエージェント主導 & PM監視)

### 1.1 設計原則の適用 (AIによる自律的判断とPMによる承認)

AIエージェントはコード生成やリファクタリングを行う際、以下の設計原則を自律的に考慮・適用し、重要な設計判断のみをPMに提示します。PMはAIからの提案をレビューし、承認または修正指示を与えます。

- **DRY (Don't Repeat Yourself)**: AIは冗長なコードを検出し、自律的に共通化するリファクタリングを実施します。大規模な変更の場合のみ、PMに提案します。
  - 例: AI「既存の複数ファイルで類似コードを発見しました。共通ユーティリティとして抽出することを計画しています。この方針で問題ないでしょうか？」 PM「承認します。」
- **SOLID原則**: AIは、これらの原則を自律的に適用し、アーキテクチャ上重要な決定のみをPMに確認します。
  - 例: AI「現在のモジュール構成では単一責任の原則に違反しているため、以下の3つのモジュールに分割する予定です。この方針で進めてよろしいでしょうか？」 PM「提案通り進めてください。」
- **セキュリティ原則 (OWASP Top 10等)**: AIはコード生成時に、インジェクション対策、認証・認可不備、機密データの公開などの一般的な脆弱性を考慮し、安全なコーディングパターンを適用します。(`devsecops_guide.md` 参照)

### 1.2 開発プロセス (AI自律実行 -> PM重要ポイントレビュー)

- **テスト駆動開発 (TDD)**: AIエージェントがIssueの内容を理解し、TDDサイクルを自律的に実行します。PMは重要な節目 (例: 主要なテストパス、大規模なリファクタリング完了時) でのみレビューを行います。
  - **AI自律実行**: AIは以下のサイクルを自律的に実行し、主要なマイルストーン到達時のみ進捗を報告します。
    1.  **Red**: 仕様に基づき、失敗するテストコードを生成。**(セキュリティテストケースも考慮)**
    2.  **Green**: テストがパスする実装コードを生成。
    3.  **Refactor**: コードの可読性・効率性を改善。
    4.  **Coverage**: カバレッジを確認し、不足していればテストケースを追加。
  - **PMレビュー**: AIからのマイルストーン報告を受け、PMはコードの方向性と全体アーキテクチャ、**および重要なセキュリティ要件**をレビューします。細かな実装詳細ではなく、戦略的な方向性の確認に注力します。
    - 例: PM「全体的なアプローチは良いですが、このモジュールは将来的にマイクロサービスとして分離する可能性があります。その点を考慮した設計にしてください。」AI「承知しました。境界をより明確にし、依存関係を最小化するよう設計を調整します。」

- **継続的なリファクタリング**: AIエージェントは、静的解析ツールの結果 (セキュリティチェック含む) やコードの複雑度に基づき、自律的にリファクタリングを実施します。大規模なリファクタリングのみ、事前にPMに提案します。
  - 例: AI「コアモジュールの循環的複雑度が高くなっています。今後の保守性向上のため、ストラテジーパターンを用いて再構成します。」 PM「承認します。」

- **コードレビュー (PMによる方向性と品質・セキュリティ確認)**: AIエージェントがIssueに対応する開発を完了したら、Pull Request (PR) を作成します。PMはPRをレビューし、コードの方向性と全体的な品質・セキュリティを確認します。
  - レビュー観点: 機能要件の充足、アーキテクチャの妥当性、テストの網羅性、**セキュリティリスク (SAST結果含む)**、パフォーマンス。
  - 問題があれば、PMは高レベルな修正方針を伝え、詳細な実装はAIに委ねます。AIは指示に基づき修正し、再度Pushします。

### 1.3 ブランチ戦略 (GitHub Flow)

開発はGitHub Flowに準拠します。AIエージェントは以下のルールで自律的にブランチを操作します：

1.  **`main` ブランチ**: 常にデプロイ可能な安定した状態を保ちます。直接コミットは禁止です。
2.  **機能ブランチ**: 新機能開発やバグ修正は、必ず `main` ブランチから分岐した機能ブランチで行います。
    - ブランチ命名規則: 
      - 機能開発: `feature/issue-{番号}-{簡潔な説明}`（例: `feature/issue-123-user-authentication`）
      - バグ修正: `fix/issue-{番号}-{簡潔な説明}`（例: `fix/issue-456-login-error`）
      - リファクタリング: `refactor/issue-{番号}-{簡潔な説明}`（例: `refactor/issue-789-improve-performance`）
    - AIエージェントはIssueの作成を検知すると、自動的に適切な命名規則に従った機能ブランチを作成します。
3.  **Pull Request**: 機能ブランチでの開発が完了したら、AIエージェントは `main` ブランチへのPull Requestを作成します。
    - PRタイトル: `[Issue #{番号}] {Issueタイトル}`（例: `[Issue #123] ユーザー認証機能の実装`）
    - PR説明: Issueの概要、実装内容の要約、テスト結果、注意点などを記載します。
4.  **レビューとマージ**: PMがPull Requestをレビューし、承認します。承認後、PM (または設定によってはAI) が機能ブランチを `main` ブランチにマージします。
5.  **デプロイ**: `main` ブランチへのマージをトリガーとして、CI/CDパイプラインが自動的にデプロイを実行します。
6.  **ブランチ削除**: マージ後、機能ブランチは自動的に削除されます。

### 1.4 Docker環境での開発 (AIによる自律的な環境利用)

開発環境とCI/CD環境の一貫性を保つため、Dockerを使用します。AIエージェントは、PMからの明示的な指示なしに、定義されたDocker環境 (`docker-compose.yml` など) を自律的に利用して、コーディング、テスト実行、コマンド実行を行います。

- **コンテナ内操作の自動化**: AIエージェントは、ファイル操作、テスト実行 (`pytest` 等)、パッケージインストールなどを、適切なDockerコンテナ内で自動的に行います。
  - 例: AIはテスト実行が必要な場合、自動的に `docker-compose run --rm test` (または同等の定義済みサービス) を実行し、結果を解釈します。
- **環境差異の吸収**: AIはDockerを使用することで、ローカル環境とCI/CD環境の差異を意識せずに開発を進めます。
- **CI/CDとの連携**: AIエージェントが作成し、PMが承認・マージしたコードは、DockerベースのCI/CDパイプラインによって自動的にテスト・ビルド・デプロイされます。

## 2. 実践的な開発フロー (AI自律実行 -> PM戦略的レビュー -> 自動統合)

`project_management_guide.md` で定義されたチケット駆動開発とHuman-In-The-Loopの原則、および `devsecops_guide.md` のセキュリティプラクティスに基づき、以下のサイクルで開発を進めます。

1.  **計画フェーズ (PM)**: PMがタスクを定義し、GitHub Issueを作成します。Issueには、背景、目的、達成基準 (Acceptance Criteria) を明確に記述します。**既知のセキュリティ要件や脅威モデルの結果も考慮します。** AIへの具体的な実装指示ではなく、「何を」達成したいかを記述します。
    - **チケットの粒度**: AIエージェントが自律的に1-2日程度で完了できる、独立した作業単位を目安とします。大きな機能は複数の関連チケットに分割し、依存関係を明示します。
    - 例: 大きな機能「ユーザー管理システム」→複数の小さなチケット「ユーザー登録API」「認証機能」「プロフィール編集UI」など

2.  **開発フェーズ (AI自律実行)**: AIエージェントがIssueを理解し、対応する機能ブランチを作成します。AIはコンテキストを把握し、適切な設計・実装アプローチを自ら決定し、コーディング、テスト (**SAST実行含む**)、リファクタリングを自律的に行います。AIは重要な設計判断やセキュリティ上の懸念点のみをPMに質問し、それ以外は自律的に進めます。

3.  **レビューフェーズ (PMによる戦略的レビュー)**: AIエージェントがIssueの達成基準を満たしたと判断したら、Pull Requestを作成します。PMはPRをレビューし、全体的な方向性、アーキテクチャの整合性、非機能要件（**セキュリティ**、パフォーマンス等）の観点からコードを評価します。**CI/CDでのSAST, SCA, シークレット検知の結果も確認します。** 細かな実装ではなく、戦略的な視点からのレビューを行います。

4.  **統合フェーズ (PM承認 -> 自動化)**: PMがPRを承認すると、自動的に `main` ブランチにマージされます。マージをトリガーとしてCI/CDパイプラインが実行され、自動テスト、ビルド、**セキュリティスキャン (DAST, コンテナスキャン等)**、デプロイが行われます。

5.  **振り返りフェーズ (AIとPMの共同学習)**: チケット完了後、AIエージェントとPMは以下の観点から振り返りを行います：
    - 目標達成度: チケットの達成基準は満たされたか？
    - プロセス効率: AIの自律的な判断は適切だったか？PMの介入は必要最小限だったか？
    - コミュニケーション: PMとAI間の認識齟齬はなかったか？
    - **セキュリティ**: 開発プロセス中にセキュリティ上の問題は発生しなかったか？テストは十分だったか？
    - 学びと改善点: 次回のチケット解決に活かせる学びは何か？
    - ドキュメント改善: 開発プロセスやガイドライン (**devsecops_guide.md含む**) の改善点はあるか？

### 2.1 CI/CDパイプラインのアプローチ (PM設定 & 自動実行)**

CI/CDパイプラインはPMが設定・管理しますが、日々の実行はAIエージェントの開発活動 (具体的にはPMによるPR承認・マージ) によって自動的にトリガーされます。**パイプラインには、`devsecops_guide.md` で定義されたセキュリティチェックが組み込まれます。**

1.  **パイプライン構成 (PM)**: PMはプロジェクト初期に、テスト、静的解析、**SAST、SCA、シークレット検知**、ビルド、**DAST、コンテナスキャン**、デプロイを含むCI/CDパイプラインをGitHub Actions等で構築します。
2.  **自動トリガー**: AIが開発しPMが承認したコードが `main` にマージされると、パイプラインが自動実行されます。
3.  **結果の監視 (PM & AI)**: パイプラインの実行結果 (**セキュリティスキャン結果含む**) は自動的に通知されます。失敗した場合、AIエージェントが自律的に原因を調査し、修正PRを作成します。PMは必要に応じて支援します。
4.  **継続的改善 (PM & AI)**: PMとAIは協力してパイプラインの効率や信頼性、**セキュリティチェックの網羅性**を定期的に見直し、必要に応じてステップの追加や設定の最適化を行います。

### 2.2 テスト駆動開発（TDD）の標準手順 (AI主体)

#### テストファイル構成

AIエージェントは、標準的なテストディレクトリ構造 (`tests/unit/`, `tests/integration/` など) に従ってテストファイルを自動的に配置します。

```
tests/
├── conftest.py          # 共通フィクスチャ
├── unit/                # ユニットテスト
│   ├── test_module1.py  # AI自律生成
│   └── test_module2.py
├── integration/         # 統合テスト
│   └── test_feature_integration.py # AI自律生成
└── security/            # セキュリティテスト (オプション)
    └── test_security_vulnerabilities.py # 特定の脆弱性再現テストなど
└── __init__.py
```

#### テストの種類と命名規則

AIエージェントは、ユニットテスト (`test_*.py`) と統合テスト (`test_*_integration.py`) を適切に区別し、標準的な命名規則に従ってテストを生成します。
**必要に応じて、特定のセキュリティ脆弱性を対象としたテスト (`tests/security/`) の生成も検討します。**

#### テスト実行 (Docker経由での自動実行)

AIエージェントは、開発プロセス中に必要に応じてDockerコンテナ経由でテストを自動実行し、その結果を自身の判断やPMへの報告に利用します。

1.  **ユニットテスト**: 実装中やリファクタリング中にAIが適宜実行。
2.  **統合テスト**: 機能の実装がある程度完了した段階やPR作成前にAIが実行。
3.  **カバレッジ測定**: PR作成前にAIが実行し、カバレッジレポートを生成・添付。

#### TDDの具体的な実施フロー (AI主体)

AIエージェントはIssueの内容を理解し、以下のTDDサイクルを自律的に実施します：

1.  AIがIssueに基づき期待される動作を分析し、テストケースを生成（失敗するテスト）。**(セキュリティ関連のテストケースも考慮)**
2.  AIが実装コードを生成（テスト通過）。
3.  AIが自律的にリファクタリングを実施。
4.  AIがカバレッジを確認し、必要に応じてテストを追加。
5.  AIが必要に応じて統合テストを追加・実行。
6.  AIがPRを作成し、実装の要約、テスト結果、カバレッジレポートを添付。
7.  PMがPRをレビュー（主に全体的なアプローチと品質、**セキュリティ**）。
8.  PMが承認または高レベルな修正指示。

## 3. 品質管理と測定 (AI自律改善 & PM監視)

### 3.1 品質指標

AIエージェントは `quality_dashboard_guide.md` で定義された指標 (**セキュリティ関連指標含む**) を自律的に監視し、問題を検出した場合は自発的に改善を行います。PMもダッシュボードを定期的に確認し、全体的な傾向や戦略的な改善が必要な領域を特定します。

### 3.2 継続的改善 (AI主導 & PM戦略)

- **品質ダッシュボードの活用**: AIエージェントはダッシュボードを常に参照し、問題や改善機会を自律的に特定・対応します。PMはより長期的なトレンドや戦略的な改善点の特定に注力します。
- **技術的負債の管理**: AIエージェントは日常的なリファクタリングを通じて小さな技術的負債を継続的に解消します。PMはより大きな技術的負債の優先順位付けと解消計画の承認を行います。
- **自動化の推進**: AIエージェントは繰り返し行われる作業 (**セキュリティチェック含む**) を特定し、自発的に自動化を提案・実装します。PMは自動化の方向性と投資判断を行います。

## 4. ツールとリソース

### 4.1 推奨ツール

- **テストフレームワーク**: pytest
- **カバレッジ測定**: pytest-cov
- **静的解析**: flake8, pylint, mypy, bandit
- **セキュリティテスト**: `Bandit`, `Semgrep`, `OWASP ZAP`, `pip-audit`, `Trivy`, `detect-secrets`, `Hadolint` (`devsecops_guide.md` 参照)
- **CI/CD**: GitHub Actions
- **コンテナ化**: Docker, docker-compose
- **AIエージェント**: Cursor, Roo Code (Cline), その他MCP対応ツール
- **MCPサーバー**: 各種コミュニティ製サーバー
- **プロジェクト管理**: GitHub (Projects, Issues, PRs)
- **品質ダッシュボード**: Grafana, 静的HTML+JS, etc.

### 4.2 参考リソース

- [pytest ドキュメント](https://docs.pytest.org/)
- [GitHub Actions ドキュメント](https://docs.github.com/en/actions)
- [Docker ドキュメント](https://docs.docker.com/)
- [Model Context Protocol (MCP)](https://modelcontextprotocol.io/)
- [GitHub Flow](https://docs.github.com/ja/get-started/quickstart/github-flow)
- (各AIエージェントのドキュメント)
- (本プロジェクト内の他のガイド: `project_management_guide.md`, `pytest_best_practices.md`, `quality_dashboard_guide.md`, **`devsecops_guide.md`**) 