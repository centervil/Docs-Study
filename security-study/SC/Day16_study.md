## 📚 今日の学習テーマ：Webアプリケーションの脆弱性

### 📝 学習の目標

* Webアプリケーションで発生する代表的な脆弱性の種類とその仕組みを理解する。
* 各脆弱性がどのように悪用されるか、具体的な攻撃シナリオを把握する。
* 脆弱性の根本原因と、それらを防ぐための基本的な対策方法を理解する。

### 🔍 カバーする範囲

本日は、Webアプリケーション開発において、特に注意すべき代表的な脆弱性であるXSS（クロスサイトスクリプティング）、SQLインジェクション、CSRF（クロスサイトリクエストフォージェリ）、および認可不備について、その構造と攻撃手法、対策を学習します。

## 📖 解説パート

### XSS（クロスサイトスクリプティング）

クロスサイトスクリプティング（XSS）は、Webアプリケーションの脆弱性を利用して、悪意のあるスクリプトを他のユーザーのブラウザ上で実行させる攻撃です。主に、ユーザーからの入力値を適切にサニタイズ（無害化）せずにHTMLに埋め込むことで発生します。攻撃者は、この脆弱性を悪用して、セッションクッキーの窃取、フィッシングサイトへの誘導、Webサイトの改ざんなどを行います。

XSSには、以下の3つの種類があります。

1.  **反射型XSS**: 攻撃者が用意したURLをユーザーにクリックさせることで、URLに含まれるスクリプトがWebサーバーを経由してブラウザで実行されます。
2.  **格納型XSS**: 攻撃者がWebアプリケーションの掲示板やコメント欄などの機能を利用して、悪意のあるスクリプトをデータベースに保存させます。他のユーザーがその内容を閲覧した際に、保存されたスクリプトが実行されます。
3.  **DOM Based XSS**: Webページ上のJavaScriptが、ユーザーからの入力値を適切に処理せずにDOM（Document Object Model）を操作する際に発生します。サーバーとの通信を介さずに、クライアントサイドのJavaScriptの脆弱性を突きます。

これらのXSS攻撃を防ぐためには、ユーザーからの入力値を信頼せず、HTMLエスケープ処理を適切に行うことが最も重要です。また、Content Security Policy（CSP）を設定することで、ブラウザが実行できるスクリプトのソースを制限することも有効な対策となります。

#### 重要ポイント

*   XSSは、ユーザーのブラウザ上で悪意のあるスクリプトを実行させる攻撃である。
*   入力値のサニタイズ（HTMLエスケープ）が不十分な場合に発生しやすい。
*   反射型、格納型、DOM Based XSSの3種類があり、それぞれ攻撃手法が異なる。
*   HTMLエスケープ処理とCSPの設定が、XSS対策の基本である。

### SQLインジェクション

SQLインジェクションは、Webアプリケーションがデータベースに発行するSQL文に、攻撃者が不正なSQLコードを注入することで、データベースを不正に操作する攻撃です。ユーザーからの入力値をSQL文に直接埋め込むことで発生します。この攻撃により、データベース内の機密情報の窃取、データの改ざん・削除、さらにはデータベースサーバーの乗っ取りにつながる可能性があります。

例えば、ログインフォームでユーザー名とパスワードを入力する際に、ユーザー名に `' OR '1'='1` のような文字列を入力すると、本来であればユーザー名とパスワードの一致を確認するSQL文が、常に真となる条件で実行されてしまい、認証を回避できてしまうことがあります。

SQLインジェクションを防ぐための最も効果的な対策は、プリペアドステートメント（パラメータ化クエリ）を使用することです。プリペアドステートメントでは、SQL文の構造とデータを分離して扱うため、入力値がSQLコードとして解釈されることを防ぎます。また、入力値のバリデーション（形式チェック）や、データベースユーザーに必要最小限の権限のみを付与することも、被害を軽減する上で重要です。

#### 重要ポイント

*   SQLインジェクションは、SQL文に不正なコードを注入する攻撃である。
*   データベース内の情報漏洩や改ざん、削除につながる。
*   プリペアドステートメントの使用が最も効果的な対策である。
*   入力値のバリデーションと権限管理も重要である。

### CSRF（クロスサイトリクエストフォージェリ）

クロスサイトリクエストフォージェリ（CSRF）は、ユーザーがログインしているWebサイトとは別の悪意のあるWebサイトやメールなどを閲覧した際に、ユーザーの意図しない操作を強制的に実行させる攻撃です。攻撃者は、ユーザーが正規のWebサイトにログインしている状態を利用して、そのユーザーの認証情報（セッションクッキーなど）を悪用します。

例えば、ユーザーがECサイトにログインしている状態で、攻撃者が用意した悪意のあるWebページを閲覧させます。そのページには、ユーザーの意図とは無関係に、ECサイトへの商品購入リクエストなどを送信するコードが埋め込まれています。ブラウザは、正規のECサイトへのリクエストと判断し、ユーザーのセッション情報を含めて送信してしまうため、意図しない購入処理などが実行されてしまいます。

CSRF攻撃を防ぐためには、重要な操作を行う際に、CSRFトークンと呼ばれるランダムな値を生成し、リクエストに含める方法が一般的です。サーバー側では、このトークンが正しいかを確認することで、正規のユーザーからのリクエストであるかを判断します。また、HTTPヘッダーの `Referer` や `Origin` をチェックすることも補助的な対策となります。

#### 重要ポイント

*   CSRFは、ユーザーの意図しない操作を強制させる攻撃である。
*   ユーザーが正規サイトにログインしている状態を悪用する。
*   CSRFトークンによる検証が最も効果的な対策である。
*   `Referer` や `Origin` ヘッダーのチェックも補助的に有効。

### 認可不備

認可不備は、ユーザーが本来アクセス権限を持たないリソースや機能に対して、不正にアクセスできてしまう脆弱性です。これは、Webアプリケーションがユーザーの認証（誰であるか）は正しく行っているものの、そのユーザーが「何ができるか」（認可）のチェックが不十分な場合に発生します。

例えば、一般ユーザーが管理者権限を持つユーザーしかアクセスできない管理画面のURLに直接アクセスしたり、他のユーザーの個人情報ページに、IDを推測・変更することでアクセスできてしまうケースなどが該当します。

認可不備を防ぐためには、すべてのリソースや機能へのアクセス要求に対して、常にユーザーの権限を確認する処理を実装することが不可欠です。具体的には、ユーザーがログインしているセッション情報と、要求された操作やリソースに対する権限を照合し、権限がない場合はアクセスを拒否する仕組みを構築します。また、URLやパラメータを推測されにくいように設計することも、攻撃の難易度を上げる上で有効です。

#### 重要ポイント

*   認可不備は、権限のないリソースや機能への不正アクセスを許す脆弱性である。
*   認証は成功しても、認可のチェックが不十分な場合に発生する。
*   すべてのアクセス要求に対して、常に権限確認を行う必要がある。
*   URLやパラメータの推測困難化も対策の一つとなる。

## 🏢 ケーススタディ

### ケース：オンラインフォーラムにおける情報漏洩

あるオンラインフォーラムでは、ユーザーが投稿したコメントがそのまま表示される仕様でした。ある攻撃者は、このフォーラムの投稿機能を利用して、悪意のあるJavaScriptコードを仕込んだコメントを投稿しました。他のユーザーがそのコメントを閲覧した際、投稿されていたJavaScriptコードが実行され、ユーザーのセッションクッキーが攻撃者に送信されてしまいました。その結果、複数のユーザーの個人情報が窃取されるインシデントが発生しました。

#### 問題点

*   ユーザーからの入力値（コメント）に対するサニタイズ処理が不十分であった。
*   投稿された内容が、そのままHTMLとして解釈・表示されてしまっていた。
*   ユーザーのセッションクッキーが、JavaScriptから容易に取得できる状態であった。

#### 対応策

*   投稿されるコメントに含まれるHTMLタグやJavaScriptコードを無効化（エスケープ処理）する。
*   コメント表示時には、信頼できるHTMLタグのみを許可するホワイトリスト方式を採用する。
*   Content Security Policy (CSP) を設定し、スクリプトの実行元を制限する。
*   セッションクッキーに `HttpOnly` 属性を付与し、JavaScriptからのアクセスを禁止する。

#### ケースから学ぶ教訓

*   ユーザーからの入力は常に信頼せず、適切なサニタイズ処理を施すことが不可欠である。
*   Webアプリケーションの表示部分（フロントエンド）だけでなく、バックエンドでの堅牢なセキュリティ対策が重要である。
*   セッション管理におけるセキュリティ設定（HttpOnly属性など）を怠らない。

## 📝 理解度チェックテスト

以下の問題を解いて、今日の学習内容の理解度をチェックしましょう。

### 問題1

Webアプリケーションの脆弱性であるXSS（クロスサイトスクリプティング）に関して、最も適切な説明はどれか。

1.  データベースに不正なSQL文を注入し、情報を不正に操作する攻撃。
2.  ユーザーのブラウザ上で悪意のあるスクリプトを実行させる攻撃。
3.  ユーザーの意図しない操作を強制的に実行させる攻撃。
4.  認証情報を窃取するために、偽のログインページに誘導する攻撃。

### 問題2

